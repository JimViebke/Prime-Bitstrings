#pragma once

/*
What is the relative value of a div test? That is, how often does a given test "hit" by discovering that a given number is composite?

Normally, this would be the reciprocal of the prime used, because 1/n of all numbers are divisible by n.

However, tests performed before div testing disproportionately affect which numbers are subject to div tests. Further, running div tests in a given order also affects the relative value of each test.

Therefore, to better determine the order-independent value of each test, we count how many times each one hits during a custom build, in which we run through the whole list instead of breaking when a composite is detected.

The results of a run are pasted below, and can be consumed during compilation as one of the heuristics used to order the div tests.



As an alternative to this, we could count hits during run time, and periodically use them to re-order the tests. This would be adaptable and remove the dependency on hardcoded counts, but we already know that generating these counts requires substantial overhead.
*/

#include <array>

#include "types.hpp"
#include "../math/math.hpp"

namespace mbp::div_test
{
	namespace detail
	{
		struct record
		{
			uint16_t base, prime;
			uint32_t hits;
		};

		constexpr std::array<record, 259> records{
			record{ 12, 29, 3235599 },
			{ 12, 19, 3182846 },
			{ 8, 19, 3100560 },
			{ 9, 17, 2964313 },
			{ 7, 17, 2956442 },
			{ 5, 17, 2952690 },
			{ 10, 17, 2952033 },
			{ 3, 17, 2951224 },
			{ 6, 17, 2950834 },
			{ 12, 17, 2950423 },
			{ 11, 17, 2950237 },
			{ 6, 37, 2947449 },
			{ 8, 17, 2943943 },
			{ 7, 19, 2860562 },
			{ 11, 19, 2805059 },
			{ 6, 19, 2658515 },
			{ 3, 19, 2656477 },
			{ 9, 19, 2653939 },
			{ 5, 19, 2650870 },
			{ 4, 19, 2648952 },
			{ 10, 19, 2639740 },
			{ 6, 23, 2185822 },
			{ 9, 23, 2184697 },
			{ 11, 23, 2184399 },
			{ 8, 23, 2183430 },
			{ 3, 23, 2182940 },
			{ 5, 23, 2181947 },
			{ 7, 23, 2181734 },
			{ 10, 23, 2180968 },
			{ 12, 23, 2180291 },
			{ 4, 23, 2179938 },
			{ 5, 29, 1750327 },
			{ 6, 29, 1746502 },
			{ 4, 29, 1741322 },
			{ 9, 29, 1740799 },
			{ 7, 29, 1738219 },
			{ 4, 31, 1737551 },
			{ 11, 29, 1731588 },
			{ 8, 29, 1729737 },
			{ 10, 29, 1729157 },
			{ 3, 29, 1727225 },
			{ 8, 31, 1644130 },
			{ 12, 31, 1618852 },
			{ 3, 31, 1618276 },
			{ 4, 41, 1616902 },
			{ 7, 31, 1615812 },
			{ 10, 31, 1615499 },
			{ 11, 31, 1614626 },
			{ 9, 31, 1613474 },
			{ 10, 41, 1459775 },
			{ 8, 37, 1406632 },
			{ 7, 37, 1368769 },
			{ 3, 37, 1368402 },
			{ 9, 37, 1361907 },
			{ 4, 37, 1359340 },
			{ 12, 37, 1359307 },
			{ 5, 37, 1356720 },
			{ 9, 41, 1268378 },
			{ 7, 41, 1224161 },
			{ 6, 41, 1223954 },
			{ 12, 41, 1223445 },
			{ 11, 41, 1222342 },
			{ 5, 41, 1220761 },
			{ 8, 41, 1217806 },
			{ 8, 43, 1179972 },
			{ 4, 43, 1171322 },
			{ 11, 43, 1169995 },
			{ 12, 43, 1167350 },
			{ 3, 43, 1167020 },
			{ 5, 43, 1166303 },
			{ 9, 43, 1166071 },
			{ 10, 43, 1165316 },
			{ 9, 61, 1134051 },
			{ 3, 41, 1127840 },
			{ 3, 61, 1103611 },
			{ 6, 31, 1078180 },
			{ 12, 47, 1068206 },
			{ 3, 47, 1067689 },
			{ 11, 47, 1067659 },
			{ 10, 47, 1067333 },
			{ 5, 47, 1067204 },
			{ 8, 47, 1067137 },
			{ 6, 47, 1066811 },
			{ 4, 47, 1066454 },
			{ 9, 47, 1065968 },
			{ 7, 47, 1065854 },
			{ 5, 71, 969887 },
			{ 3, 53, 947658 },
			{ 9, 53, 947545 },
			{ 8, 53, 947073 },
			{ 10, 53, 946867 },
			{ 7, 53, 946723 },
			{ 11, 53, 946573 },
			{ 5, 53, 946250 },
			{ 12, 53, 946114 },
			{ 4, 53, 945989 },
			{ 6, 53, 945687 },
			{ 5, 31, 920936 },
			{ 11, 59, 851835 },
			{ 9, 59, 850940 },
			{ 6, 59, 850520 },
			{ 5, 59, 850266 },
			{ 4, 59, 849819 },
			{ 3, 59, 849598 },
			{ 10, 59, 849592 },
			{ 7, 59, 849498 },
			{ 12, 59, 849166 },
			{ 8, 59, 848438 },
			{ 12, 61, 826406 },
			{ 5, 61, 825360 },
			{ 8, 61, 824825 },
			{ 4, 61, 824750 },
			{ 6, 61, 822880 },
			{ 10, 61, 821022 },
			{ 7, 61, 820850 },
			{ 3, 67, 750076 },
			{ 9, 67, 749566 },
			{ 12, 67, 749488 },
			{ 5, 67, 749389 },
			{ 8, 67, 749354 },
			{ 7, 67, 749036 },
			{ 6, 67, 748334 },
			{ 10, 67, 748006 },
			{ 4, 67, 747524 },
			{ 11, 67, 747405 },
			{ 10, 73, 722235 },
			{ 6, 71, 708178 },
			{ 3, 71, 707202 },
			{ 4, 71, 707132 },
			{ 8, 71, 707097 },
			{ 7, 71, 707011 },
			{ 11, 71, 706500 },
			{ 12, 71, 706470 },
			{ 10, 71, 705992 },
			{ 9, 71, 705976 },
			{ 4, 73, 697265 },
			{ 6, 101, 694135 },
			{ 7, 73, 689633 },
			{ 5, 73, 687833 },
			{ 12, 73, 687794 },
			{ 6, 73, 687140 },
			{ 11, 73, 686270 },
			{ 10, 79, 636198 },
			{ 9, 79, 635473 },
			{ 3, 79, 635123 },
			{ 5, 79, 634863 },
			{ 8, 79, 634831 },
			{ 4, 79, 634811 },
			{ 12, 79, 634774 },
			{ 7, 79, 634629 },
			{ 6, 79, 634557 },
			{ 11, 79, 634378 },
			{ 11, 37, 622283 },
			{ 3, 73, 617302 },
			{ 10, 83, 606502 },
			{ 6, 83, 605500 },
			{ 9, 83, 604771 },
			{ 11, 83, 604727 },
			{ 12, 83, 604587 },
			{ 4, 83, 604203 },
			{ 7, 83, 604020 },
			{ 3, 83, 603927 },
			{ 8, 83, 603616 },
			{ 5, 83, 603516 },
			{ 11, 89, 564928 },
			{ 7, 89, 564804 },
			{ 3, 89, 564283 },
			{ 5, 89, 563735 },
			{ 9, 89, 563246 },
			{ 10, 89, 563090 },
			{ 6, 89, 563084 },
			{ 8, 89, 563082 },
			{ 4, 89, 562990 },
			{ 5, 97, 517922 },
			{ 11, 97, 517622 },
			{ 3, 97, 517495 },
			{ 7, 97, 516748 },
			{ 12, 97, 516351 },
			{ 8, 97, 516263 },
			{ 10, 97, 516014 },
			{ 9, 97, 515414 },
			{ 4, 97, 515279 },
			{ 12, 89, 511433 },
			{ 4, 101, 497692 },
			{ 3, 101, 496825 },
			{ 12, 101, 496561 },
			{ 5, 101, 496397 },
			{ 9, 101, 496370 },
			{ 7, 101, 496308 },
			{ 11, 101, 495801 },
			{ 8, 101, 495774 },
			{ 10, 103, 488457 },
			{ 5, 103, 488177 },
			{ 9, 103, 487205 },
			{ 4, 103, 487047 },
			{ 3, 103, 486968 },
			{ 6, 103, 486767 },
			{ 8, 103, 486708 },
			{ 7, 103, 486684 },
			{ 11, 103, 486619 },
			{ 12, 103, 486523 },
			{ 10, 37, 486061 },
			{ 4, 107, 469851 },
			{ 12, 107, 469332 },
			{ 9, 107, 469330 },
			{ 5, 107, 469136 },
			{ 3, 107, 468876 },
			{ 7, 107, 468524 },
			{ 10, 107, 468505 },
			{ 11, 107, 468358 },
			{ 6, 107, 467816 },
			{ 8, 107, 467655 },
			{ 6, 109, 461512 },
			{ 11, 109, 460831 },
			{ 7, 109, 460019 },
			{ 3, 109, 459950 },
			{ 12, 109, 459906 },
			{ 5, 109, 459686 },
			{ 10, 109, 459668 },
			{ 9, 109, 459172 },
			{ 7, 113, 453290 },
			{ 4, 113, 450082 },
			{ 4, 109, 444805 },
			{ 6, 113, 444725 },
			{ 9, 113, 444464 },
			{ 10, 113, 443891 },
			{ 3, 113, 443770 },
			{ 5, 113, 443767 },
			{ 11, 113, 443688 },
			{ 12, 113, 442335 },
			{ 8, 113, 442242 },
			{ 6, 97, 408528 },
			{ 8, 127, 398144 },
			{ 11, 127, 395715 },
			{ 12, 127, 395673 },
			{ 7, 127, 395274 },
			{ 5, 127, 395264 },
			{ 10, 127, 394893 },
			{ 3, 127, 394771 },
			{ 6, 127, 394732 },
			{ 9, 127, 394711 },
			{ 4, 127, 392518 },
			{ 10, 131, 383411 },
			{ 8, 131, 383393 },
			{ 11, 131, 383001 },
			{ 6, 131, 382973 },
			{ 3, 131, 382972 },
			{ 4, 131, 382903 },
			{ 12, 131, 382681 },
			{ 5, 131, 382534 },
			{ 7, 131, 382469 },
			{ 9, 131, 381938 },
			{ 8, 109, 375848 },
			{ 7, 43, 364165 },
			{ 11, 61, 305835 },
			{ 6, 43, 272350 },
			{ 9, 73, 19704 },
			{ 10, 101, 19424 },
			{ 8, 73, 16653 }
		};
	}

	consteval uint32_t cached_hitcount_for(const auto base, const auto prime)
	{
		// Kind of icky compile-time linear search
		for (const auto& r : detail::records)
		{
			if (r.base == base && r.prime == prime)
			{
				return r.hits;
			}
		}

		return uint32_t(-1);
	}

}
